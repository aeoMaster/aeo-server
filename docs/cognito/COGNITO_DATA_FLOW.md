# Cognito Authentication Data Flow

This document outlines the complete data flow and management in the Cognito authentication system, ensuring parity with the traditional signup/login flow.

## Architecture Overview (BFF Model)

The Backend-for-Frontend (BFF) model means:

- Frontend redirects users to Cognito Hosted UI
- Cognito handles authentication (email/password, Google, etc.)
- Backend receives OAuth code, exchanges for tokens
- Backend validates tokens, creates/updates user in database
- Backend issues its own secure session cookie
- Frontend makes API calls with session cookie

## Authentication Routes

### 1. Login Flow

**Endpoint:** `GET /api/auth/login`

**Flow:**

1. Generates PKCE code verifier and challenge
2. Generates CSRF state token
3. Redirects to Cognito Hosted UI with:
   - `response_type=code`
   - `client_id`
   - `redirect_uri` (points back to callback)
   - `scope=openid email profile`
   - `state` (for CSRF protection)
   - `code_challenge` (PKCE)

**Example:**

```
https://your-app.auth.us-east-1.amazoncognito.com/oauth2/authorize?
  response_type=code&
  client_id=xxxxx&
  redirect_uri=https://api.yourapp.com/api/auth/callback&
  scope=openid+email+profile&
  state=random-state&
  code_challenge=challenge&
  code_challenge_method=S256
```

---

### 2. OAuth Callback (Critical - User Creation Happens Here)

**Endpoint:** `GET /api/auth/callback?code=XXX&state=YYY`

**Flow:**

1. **Validates state** (CSRF protection)
2. **Exchanges code for tokens** via Cognito `/oauth2/token` endpoint
   - Receives: `id_token`, `access_token`, `refresh_token`
3. **Verifies id_token** signature using Cognito JWKS
4. **Extracts user info** from token payload:
   - `sub` (Cognito unique user ID)
   - `email`
   - `name` (or `given_name`, `family_name`)
   - `cognito:groups` (user groups)
5. **Maps Cognito groups to application roles**
6. **Upserts user in database** (see below for details)
7. **Creates secure session** (HttpOnly cookie)
8. **Redirects to frontend** dashboard

**User Data Created/Updated:**

**For New Users (Signup):**

```typescript
{
  cognitoSub: string,           // Cognito's unique user ID (PRIMARY KEY)
  email: string,                // User email
  name: string,                 // Full name or email prefix
  roles: string[],              // ["user", "admin", etc.]
  cognitoGroups: string[],      // Cognito groups
  role: string,                 // Legacy single role field
  status: "active",             // Account status
  lastLogin: Date,              // Current timestamp
  createdAt: Date,              // Auto-generated by MongoDB
  updatedAt: Date               // Auto-generated by MongoDB
}
```

**CRITICAL: Subscription Creation (Atomic Operation)**

When a new user is created, the system MUST create:

1. **Free Tier Subscription:**

```typescript
{
  user: ObjectId,               // Reference to user
  package: ObjectId,            // Reference to "Free" package
  status: "active",
  billingCycle: "monthly",
  currentPeriodStart: Date,
  currentPeriodEnd: Date,       // +30 days
  stripeSubscriptionId: string, // local_timestamp
  stripeCustomerId: string      // local_userId
}
```

2. **Usage Records (4 types):**

```typescript
// Created for each type: analysis, clarity_scan, chat_message, storage
{
  user: ObjectId,
  type: "analysis" | "clarity_scan" | "chat_message" | "storage",
  period: {
    start: Date,
    end: Date                   // +30 days
  },
  limits: {
    total: number,              // Based on package (e.g., 2 for analysis)
    used: 0,
    remaining: number           // Same as total initially
  },
  count: 0
}
```

**Default Limits for Free Tier:**

- `analysis`: 2 total, 0 used, 2 remaining
- `clarity_scan`: 5 total, 0 used, 5 remaining
- `chat_message`: 0 total, 0 used, 0 remaining
- `storage`: 100 total, 0 used, 100 remaining

**Atomicity Guarantee:**
If subscription creation fails, the user is DELETED and login fails with:

```
Error 500: "Failed to create user subscription. Please try again."
```

This ensures NO users exist without subscriptions (data consistency).

**For Existing Users (Login):**

```typescript
{
  // Updates only:
  cognitoSub: string,           // Ensure it's set
  email: string,                // Update if changed in Cognito
  name: string,                 // Update if changed
  roles: string[],              // Update based on current groups
  cognitoGroups: string[],      // Update current groups
  role: string,                 // Update legacy field
  lastLogin: Date               // Update to current timestamp
}
```

**Session Cookie Created:**

```typescript
{
  sessionId: string,            // UUID
  userId: string,               // cognitoSub
  cognitoSub: string,           // Cognito's sub
  email: string,
  name: string,
  roles: string[],
  groups: string[],
  createdAt: Date,
  lastAccessedAt: Date
}
```

**Cookie Properties:**

- Name: `aeo_session` (configurable)
- HttpOnly: `true`
- Secure: `true` (in production)
- SameSite: `strict`
- MaxAge: 28800 seconds (8 hours, configurable)

---

### 3. Get Current User

**Endpoint:** `GET /api/auth/me`

**Returns:**

```json
{
  "status": "success",
  "user": {
    "id": "cognito-sub-id",
    "email": "user@example.com",
    "name": "John Doe",
    "roles": ["user"],
    "groups": []
  }
}
```

---

### 4. Logout

**Endpoint:** `POST /api/auth/logout`

**Flow:**

1. Destroys server session
2. Clears session cookie
3. Returns Cognito logout URL

**Response:**

```json
{
  "status": "success",
  "message": "Logged out successfully",
  "logoutUrl": "https://your-app.auth.us-east-1.amazoncognito.com/logout?client_id=xxx&logout_uri=https://yourapp.com"
}
```

Frontend should redirect to `logoutUrl` to complete logout.

---

### 5. Password Reset

**Endpoints:**

- `POST /api/auth/forgot-password`
- `POST /api/auth/confirm-forgot-password`

These delegate to Cognito's password reset flow.

---

## Data Parity: Traditional vs Cognito

### Traditional Signup Flow (auth.ts)

**POST /api/auth/signup**

```typescript
// Input: { name, email, password }

1. Validates input (Zod schema)
2. Checks if user exists
3. Creates user with bcrypt-hashed password
4. Creates free tier subscription
   - If fails: DELETES user and returns 500
5. Generates JWT token
6. Returns: { token, user: { id, name, email } }
```

### Cognito Signup Flow (cognitoAuth.ts)

**GET /api/auth/callback (after Cognito authentication)**

```typescript
// Input: OAuth code from Cognito

1. Validates state (CSRF)
2. Exchanges code for tokens
3. Verifies JWT signature
4. Extracts user info from token
5. Maps groups to roles
6. Creates user (if new)
7. Creates free tier subscription
   - If fails: DELETES user and returns 500
8. Creates session cookie
9. Redirects to frontend
```

### Key Differences

| Aspect                | Traditional                                       | Cognito                         |
| --------------------- | ------------------------------------------------- | ------------------------------- |
| Password Storage      | bcrypt hash in DB                                 | Managed by Cognito              |
| User Identifier       | MongoDB \_id                                      | Cognito sub                     |
| Authentication Token  | JWT signed by server                              | Session cookie + Cognito tokens |
| User Creation         | Explicit signup endpoint                          | Implicit on first login         |
| Subscription Creation | Both enforce atomic creation with rollback        |
| Data Stored           | Same core data (email, name, subscription, usage) |

---

## Middleware Integration

### Authentication Middleware

**File:** `src/middleware/cognitoAuth.ts`

**Middlewares:**

1. **`requireAuth`** - Ensures user is authenticated

   - Checks session cookie
   - Loads user from database
   - Attaches `req.cognitoUser` and `req.user`
   - Returns 401 if not authenticated

2. **`requireRole(role)`** - Requires specific role

   - Checks if user has the required role
   - Returns 403 if not authorized

3. **`requireAnyRole(roles[])`** - Requires any of the roles

   - Checks if user has at least one of the roles
   - Returns 403 if not authorized

4. **`requirePermission(permission)`** - Requires specific permission

   - Checks if user's roles grant the permission
   - Returns 403 if not authorized

5. **`optionalAuth`** - Attaches user if authenticated
   - Doesn't fail if not authenticated
   - Useful for public endpoints with optional features

**Usage Example:**

```typescript
import { requireAuth, requireRole } from "./middleware/cognitoAuth";

// Protected route
router.get("/api/profile", requireAuth, async (req, res) => {
  const user = req.cognitoUser; // or req.user
  // ...
});

// Admin-only route
router.delete(
  "/api/users/:id",
  requireAuth,
  requireRole("admin"),
  async (req, res) => {
    // ...
  }
);
```

---

## Session Management

**File:** `src/services/sessionService.ts`

**Storage:**

- **Development:** Memory store (memorystore)
- **Production:** Redis store (connect-redis)

**Session Data Structure:**

```typescript
interface ISessionData {
  sessionId: string;
  userId: string; // Same as cognitoSub
  cognitoSub: string; // Cognito's unique ID
  email: string;
  name?: string;
  roles: string[];
  groups: string[];
  createdAt: Date;
  lastAccessedAt: Date;
}
```

**Methods:**

- `createSession(req, userData)` - Creates new session
- `getSessionData(req)` - Gets session data
- `destroySession(req)` - Destroys session
- `isAuthenticated(req)` - Checks if authenticated
- `getUserRoles(req)` - Gets user roles
- `hasRole(req, role)` - Checks if user has role
- `hasAnyRole(req, roles[])` - Checks if user has any role

---

## Environment Variables Required

```bash
# Auth Provider
AUTH_PROVIDER=cognito

# Cognito Configuration
COGNITO_REGION=us-east-1
COGNITO_USER_POOL_ID=us-east-1_xxxxxxxxx
COGNITO_APP_CLIENT_ID=your-app-client-id
AWS_COGNITO_CLIENT_ID=your-app-client-id  # Alias
COGNITO_DOMAIN=https://your-app.auth.us-east-1.amazoncognito.com

# OAuth URLs
OAUTH_REDIRECT_URI=https://api.yourapp.com/api/auth/callback
OAUTH_LOGOUT_REDIRECT_URI=https://yourapp.com

# Session
SESSION_SECRET=your-secret-min-32-characters
SESSION_TTL_SECONDS=28800
COOKIE_NAME=aeo_session

# Redis (production)
REDIS_URL=redis://your-redis-url

# Frontend
FRONTEND_ORIGIN=https://yourapp.com
CLIENT_URL=https://yourapp.com
```

---

## Security Features

### 1. PKCE (Proof Key for Code Exchange)

- Prevents authorization code interception attacks
- Code verifier generated, challenge sent to Cognito
- Verifier used when exchanging code for tokens

### 2. CSRF Protection

- State parameter generated and validated
- Stored with 10-minute TTL
- Prevents cross-site request forgery

### 3. JWT Validation

- ID token signature verified using Cognito JWKS
- Issuer validated (`https://cognito-idp.us-east-1.amazonaws.com/...`)
- Expiration checked

### 4. Secure Cookies

- HttpOnly (JavaScript cannot access)
- Secure (HTTPS only in production)
- SameSite=strict (CSRF protection)
- Auto-expires after 8 hours (configurable)

### 5. Rate Limiting

- Auth endpoints: Limited requests per IP
- Password reset: Extra strict limits
- API endpoints: Configurable rate limits

---

## Summary

✅ **All data from traditional signup is preserved in Cognito flow:**

- User record created with all fields
- Free tier subscription created atomically
- Usage records initialized properly
- Session/token management secure

✅ **Atomicity guaranteed:**

- If subscription creation fails, user is deleted
- No partial data states

✅ **Security enhanced:**

- PKCE prevents code interception
- CSRF protection via state parameter
- Secure HttpOnly cookies
- JWT signature validation

✅ **Architecture follows BFF model:**

- Backend handles all Cognito communication
- Frontend only deals with session cookies
- No sensitive tokens exposed to browser
